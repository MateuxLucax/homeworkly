-- https://jsonformatter.org/ para formatar JSON

/* metodo utilizado para analisar custo de consultas
  EXPLAIN (
    ANALYZE TRUE,
    COSTS TRUE,
    FORMAT json
  )
*/

-- criacao de indices
CREATE INDEX idx_titulo_tarefa ON tarefa USING btree (titulo);
CREATE INDEX idx_turma_ano ON turma USING hash (ano);
CREATE INDEX idx_nome_usuario ON usuario USING btree (nome);

-- 1
SELECT
	t.nome,
	jsonb_agg(json_build_object(
    'nome', results.disciplina,
    'id', results.id_disciplina,
    'alunos', results.alunos
  )) AS disciplinas
FROM
	(
		SELECT
			d.nome AS disciplina,
			d.id_disciplina,
			t.id_turma,
			json_agg(results.alunos) AS alunos
		FROM
			(
				SELECT
					d.id_disciplina,
					json_build_object(
            'nome', u.nome,
            'tarefas', count(DISTINCT(ta.id_tarefa)),
            'nota_media', avg(a.nota) 
          ) AS alunos
				FROM
					disciplina d
				INNER JOIN turma t ON
					d.id_turma = t.id_turma
				INNER JOIN tarefa ta ON
					ta.id_disciplina = d.id_disciplina
				INNER JOIN professor_de_disciplina pdd ON
					pdd.id_disciplina = d.id_disciplina
				INNER JOIN aluno_em_turma aet ON
					aet.id_turma = t.id_turma
				INNER JOIN usuario u ON
					u.id_usuario = aet.id_aluno
				LEFT JOIN avaliacao a ON
					a.id_aluno = u.id_usuario
				WHERE
					pdd.id_professor = :id_professor
					AND t.id_turma = :id_turma
				GROUP BY
					1,
					u.nome
			) AS results
		JOIN disciplina d ON
			d.id_disciplina = results.id_disciplina
		JOIN turma t ON
			d.id_turma = t.id_turma
		GROUP BY
			1,
			2,
			3
	) AS results
JOIN turma t ON
	t.id_turma = results.id_turma
GROUP BY
	1;

/** EXPLAIN ANALYZE antes dos indices
 * [{"Plan":{"Node Type":"Aggregate","Strategy":"Sorted","Partial Mode":"Simple","Parallel Aware":false,"Async Capable":false,"Startup Cost":179.05,"Total Cost":179.41,"Plan Rows":16,"Plan Width":64,"Actual Startup Time":0.672,"Actual Total Time":0.68,"Actual Rows":1,"Actual Loops":1,"Group Key":["t.nome"],"Plans":[{"Node Type":"Sort","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Startup Cost":179.05,"Total Cost":179.09,"Plan Rows":16,"Plan Width":100,"Actual Startup Time":0.62,"Actual Total Time":0.628,"Actual Rows":1,"Actual Loops":1,"Sort Key":["t.nome"],"Sort Method":"quicksort","Sort Space Used":25,"Sort Space Type":"Memory","Plans":[{"Node Type":"Hash Join","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":152.07,"Total Cost":178.73,"Plan Rows":16,"Plan Width":100,"Actual Startup Time":0.598,"Actual Total Time":0.607,"Actual Rows":1,"Actual Loops":1,"Inner Unique":false,"Hash Cond":"(t.id_turma = results.id_turma)","Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"turma","Alias":"t","Startup Cost":0,"Total Cost":22,"Plan Rows":1200,"Plan Width":36,"Actual Startup Time":0.01,"Actual Total Time":0.011,"Actual Rows":3,"Actual Loops":1},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Startup Cost":151.87,"Total Cost":151.87,"Plan Rows":16,"Plan Width":72,"Actual Startup Time":0.563,"Actual Total Time":0.57,"Actual Rows":1,"Actual Loops":1,"Hash Buckets":1024,"Original Hash Buckets":1024,"Hash Batches":1,"Original Hash Batches":1,"Peak Memory Usage":9,"Plans":[{"Node Type":"Subquery Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Alias":"results","Startup Cost":151.35,"Total Cost":151.87,"Plan Rows":16,"Plan Width":72,"Actual Startup Time":0.548,"Actual Total Time":0.555,"Actual Rows":1,"Actual Loops":1,"Plans":[{"Node Type":"Aggregate","Strategy":"Sorted","Partial Mode":"Simple","Parent Relationship":"Subquery","Parallel Aware":false,"Async Capable":false,"Startup Cost":151.35,"Total Cost":151.71,"Plan Rows":16,"Plan Width":72,"Actual Startup Time":0.547,"Actual Total Time":0.554,"Actual Rows":1,"Actual Loops":1,"Group Key":["d.id_disciplina","t_1.id_turma"],"Plans":[{"Node Type":"Sort","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Startup Cost":151.35,"Total Cost":151.39,"Plan Rows":16,"Plan Width":72,"Actual Startup Time":0.538,"Actual Total Time":0.545,"Actual Rows":4,"Actual Loops":1,"Sort Key":["d.id_disciplina","t_1.id_turma"],"Sort Method":"quicksort","Sort Space Used":25,"Sort Space Type":"Memory","Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":122.09,"Total Cost":151.03,"Plan Rows":16,"Plan Width":72,"Actual Startup Time":0.511,"Actual Total Time":0.528,"Actual Rows":4,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Hash Join","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":121.93,"Total Cost":147.63,"Plan Rows":16,"Plan Width":76,"Actual Startup Time":0.449,"Actual Total Time":0.458,"Actual Rows":4,"Actual Loops":1,"Inner Unique":false,"Hash Cond":"(d.id_disciplina = results_1.id_disciplina)","Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"disciplina","Alias":"d","Startup Cost":0,"Total Cost":21.3,"Plan Rows":1130,"Plan Width":44,"Actual Startup Time":0.004,"Actual Total Time":0.005,"Actual Rows":5,"Actual Loops":1},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Startup Cost":121.73,"Total Cost":121.73,"Plan Rows":16,"Plan Width":36,"Actual Startup Time":0.42,"Actual Total Time":0.425,"Actual Rows":4,"Actual Loops":1,"Hash Buckets":1024,"Original Hash Buckets":1024,"Hash Batches":1,"Original Hash Batches":1,"Peak Memory Usage":9,"Plans":[{"Node Type":"Subquery Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Alias":"results_1","Startup Cost":121.13,"Total Cost":121.73,"Plan Rows":16,"Plan Width":36,"Actual Startup Time":0.333,"Actual Total Time":0.414,"Actual Rows":4,"Actual Loops":1,"Plans":[{"Node Type":"Aggregate","Strategy":"Sorted","Partial Mode":"Simple","Parent Relationship":"Subquery","Parallel Aware":false,"Async Capable":false,"Startup Cost":121.13,"Total Cost":121.57,"Plan Rows":16,"Plan Width":68,"Actual Startup Time":0.332,"Actual Total Time":0.412,"Actual Rows":4,"Actual Loops":1,"Group Key":["d_1.id_disciplina","u.nome"],"Plans":[{"Node Type":"Sort","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Startup Cost":121.13,"Total Cost":121.17,"Plan Rows":16,"Plan Width":44,"Actual Startup Time":0.283,"Actual Total Time":0.288,"Actual Rows":5,"Actual Loops":1,"Sort Key":["d_1.id_disciplina","u.nome"],"Sort Method":"quicksort","Sort Space Used":25,"Sort Space Type":"Memory","Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":64.93,"Total Cost":120.81,"Plan Rows":16,"Plan Width":44,"Actual Startup Time":0.237,"Actual Total Time":0.266,"Actual Rows":5,"Actual Loops":1,"Inner Unique":false,"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":15.18,"Total Cost":46.99,"Plan Rows":1,"Plan Width":12,"Actual Startup Time":0.129,"Actual Total Time":0.147,"Actual Rows":1,"Actual Loops":1,"Inner Unique":false,"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":15.03,"Total Cost":38.81,"Plan Rows":1,"Plan Width":16,"Actual Startup Time":0.079,"Actual Total Time":0.096,"Actual Rows":1,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Hash Join","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":14.88,"Total Cost":32.11,"Plan Rows":26,"Plan Width":20,"Actual Startup Time":0.056,"Actual Total Time":0.061,"Actual Rows":5,"Actual Loops":1,"Inner Unique":true,"Hash Cond":"(ta.id_disciplina = pdd.id_disciplina)","Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"tarefa","Alias":"ta","Startup Cost":0,"Total Cost":15.7,"Plan Rows":570,"Plan Width":12,"Actual Startup Time":0.004,"Actual Total Time":0.005,"Actual Rows":5,"Actual Loops":1},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Startup Cost":14.76,"Total Cost":14.76,"Plan Rows":9,"Plan Width":8,"Actual Startup Time":0.035,"Actual Total Time":0.035,"Actual Rows":3,"Actual Loops":1,"Hash Buckets":1024,"Original Hash Buckets":1024,"Hash Batches":1,"Original Hash Batches":1,"Peak Memory Usage":9,"Plans":[{"Node Type":"Bitmap Heap Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"professor_de_disciplina","Alias":"pdd","Startup Cost":4.22,"Total Cost":14.76,"Plan Rows":9,"Plan Width":8,"Actual Startup Time":0.017,"Actual Total Time":0.019,"Actual Rows":3,"Actual Loops":1,"Recheck Cond":"(id_professor = 7)","Rows Removed by Index Recheck":0,"Exact Heap Blocks":1,"Lossy Heap Blocks":0,"Plans":[{"Node Type":"Bitmap Index Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Index Name":"professor_de_disciplina_pkey","Startup Cost":0,"Total Cost":4.22,"Plan Rows":9,"Plan Width":0,"Actual Startup Time":0.01,"Actual Total Time":0.011,"Actual Rows":3,"Actual Loops":1,"Index Cond":"(id_professor = 7)"}]}]}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"disciplina_pkey","Relation Name":"disciplina","Alias":"d_1","Startup Cost":0.15,"Total Cost":0.26,"Plan Rows":1,"Plan Width":12,"Actual Startup Time":0.006,"Actual Total Time":0.006,"Actual Rows":0,"Actual Loops":5,"Index Cond":"(id_disciplina = ta.id_disciplina)","Rows Removed by Index Recheck":0,"Filter":"(id_turma = 1)","Rows Removed by Filter":1}]},{"Node Type":"Index Only Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"turma_pkey","Relation Name":"turma","Alias":"t_2","Startup Cost":0.15,"Total Cost":8.17,"Plan Rows":1,"Plan Width":4,"Actual Startup Time":0.048,"Actual Total Time":0.049,"Actual Rows":1,"Actual Loops":1,"Index Cond":"(id_turma = 1)","Rows Removed by Index Recheck":0,"Heap Fetches":1}]},{"Node Type":"Hash Join","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Join Type":"Right","Startup Cost":49.75,"Total Cost":73.66,"Plan Rows":16,"Plan Width":44,"Actual Startup Time":0.105,"Actual Total Time":0.115,"Actual Rows":5,"Actual Loops":1,"Inner Unique":false,"Hash Cond":"(a.id_aluno = u.id_usuario)","Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"avaliacao","Alias":"a","Startup Cost":0,"Total Cost":20,"Plan Rows":1000,"Plan Width":12,"Actual Startup Time":0.004,"Actual Total Time":0.005,"Actual Rows":4,"Actual Loops":1},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Startup Cost":49.64,"Total Cost":49.64,"Plan Rows":9,"Plan Width":44,"Actual Startup Time":0.076,"Actual Total Time":0.077,"Actual Rows":4,"Actual Loops":1,"Hash Buckets":1024,"Original Hash Buckets":1024,"Hash Batches":1,"Original Hash Batches":1,"Peak Memory Usage":9,"Plans":[{"Node Type":"Hash Join","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":32.68,"Total Cost":49.64,"Plan Rows":9,"Plan Width":44,"Actual Startup Time":0.053,"Actual Total Time":0.06,"Actual Rows":4,"Actual Loops":1,"Inner Unique":true,"Hash Cond":"(u.id_usuario = aet.id_aluno)","Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"usuario","Alias":"u","Startup Cost":0,"Total Cost":15.5,"Plan Rows":550,"Plan Width":36,"Actual Startup Time":0.006,"Actual Total Time":0.008,"Actual Rows":9,"Actual Loops":1},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Startup Cost":32.57,"Total Cost":32.57,"Plan Rows":9,"Plan Width":16,"Actual Startup Time":0.029,"Actual Total Time":0.03,"Actual Rows":4,"Actual Loops":1,"Hash Buckets":1024,"Original Hash Buckets":1024,"Hash Batches":1,"Original Hash Batches":1,"Peak Memory Usage":9,"Plans":[{"Node Type":"Bitmap Heap Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"aluno_em_turma","Alias":"aet","Startup Cost":22.03,"Total Cost":32.57,"Plan Rows":9,"Plan Width":16,"Actual Startup Time":0.008,"Actual Total Time":0.01,"Actual Rows":4,"Actual Loops":1,"Recheck Cond":"(id_turma = 1)","Rows Removed by Index Recheck":0,"Exact Heap Blocks":1,"Lossy Heap Blocks":0,"Plans":[{"Node Type":"Bitmap Index Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Index Name":"aluno_em_turma_pkey","Startup Cost":0,"Total Cost":22.03,"Plan Rows":9,"Plan Width":0,"Actual Startup Time":0.004,"Actual Total Time":0.004,"Actual Rows":4,"Actual Loops":1,"Index Cond":"(id_turma = 1)"}]}]}]}]}]}]}]}]}]}]}]},{"Node Type":"Index Only Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"turma_pkey","Relation Name":"turma","Alias":"t_1","Startup Cost":0.15,"Total Cost":0.21,"Plan Rows":1,"Plan Width":4,"Actual Startup Time":0.016,"Actual Total Time":0.016,"Actual Rows":1,"Actual Loops":4,"Index Cond":"(id_turma = d.id_turma)","Rows Removed by Index Recheck":0,"Heap Fetches":4}]}]}]}]}]}]}]}]},"Planning Time":2.758,"Triggers":[],"Execution Time":1.332}]
 * EXPLAIN ANALYZE depois dos indices
 * [{"Plan":{"Node Type":"Aggregate","Strategy":"Sorted","Partial Mode":"Simple","Parallel Aware":false,"Async Capable":false,"Startup Cost":175.55,"Total Cost":175.62,"Plan Rows":3,"Plan Width":64,"Actual Startup Time":0.62,"Actual Total Time":0.624,"Actual Rows":1,"Actual Loops":1,"Group Key":["t.nome"],"Plans":[{"Node Type":"Sort","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Startup Cost":175.55,"Total Cost":175.56,"Plan Rows":3,"Plan Width":100,"Actual Startup Time":0.574,"Actual Total Time":0.579,"Actual Rows":1,"Actual Loops":1,"Sort Key":["t.nome"],"Sort Method":"quicksort","Sort Space Used":25,"Sort Space Type":"Memory","Plans":[{"Node Type":"Hash Join","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":173.62,"Total Cost":175.52,"Plan Rows":3,"Plan Width":100,"Actual Startup Time":0.526,"Actual Total Time":0.53,"Actual Rows":1,"Actual Loops":1,"Inner Unique":true,"Hash Cond":"(t_1.id_turma = t.id_turma)","Plans":[{"Node Type":"Aggregate","Strategy":"Sorted","Partial Mode":"Simple","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Startup Cost":172.55,"Total Cost":173.76,"Plan Rows":54,"Plan Width":72,"Actual Startup Time":0.482,"Actual Total Time":0.486,"Actual Rows":1,"Actual Loops":1,"Group Key":["d.id_disciplina","t_1.id_turma"],"Plans":[{"Node Type":"Sort","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Startup Cost":172.55,"Total Cost":172.68,"Plan Rows":54,"Plan Width":72,"Actual Startup Time":0.478,"Actual Total Time":0.482,"Actual Rows":4,"Actual Loops":1,"Sort Key":["d.id_disciplina","t_1.id_turma"],"Sort Method":"quicksort","Sort Space Used":25,"Sort Space Type":"Memory","Plans":[{"Node Type":"Hash Join","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":144.78,"Total Cost":171,"Plan Rows":54,"Plan Width":72,"Actual Startup Time":0.442,"Actual Total Time":0.447,"Actual Rows":4,"Actual Loops":1,"Inner Unique":true,"Hash Cond":"(d.id_turma = t_1.id_turma)","Plans":[{"Node Type":"Hash Join","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":143.71,"Total Cost":169.79,"Plan Rows":54,"Plan Width":76,"Actual Startup Time":0.385,"Actual Total Time":0.39,"Actual Rows":4,"Actual Loops":1,"Inner Unique":false,"Hash Cond":"(d.id_disciplina = results.id_disciplina)","Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"disciplina","Alias":"d","Startup Cost":0,"Total Cost":21.3,"Plan Rows":1130,"Plan Width":44,"Actual Startup Time":0.003,"Actual Total Time":0.004,"Actual Rows":5,"Actual Loops":1},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Startup Cost":143.03,"Total Cost":143.03,"Plan Rows":54,"Plan Width":36,"Actual Startup Time":0.369,"Actual Total Time":0.372,"Actual Rows":4,"Actual Loops":1,"Hash Buckets":1024,"Original Hash Buckets":1024,"Hash Batches":1,"Original Hash Batches":1,"Peak Memory Usage":9,"Plans":[{"Node Type":"Subquery Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Alias":"results","Startup Cost":129.18,"Total Cost":143.03,"Plan Rows":54,"Plan Width":36,"Actual Startup Time":0.333,"Actual Total Time":0.366,"Actual Rows":4,"Actual Loops":1,"Plans":[{"Node Type":"Aggregate","Strategy":"Sorted","Partial Mode":"Simple","Parent Relationship":"Subquery","Parallel Aware":false,"Async Capable":false,"Startup Cost":129.18,"Total Cost":142.49,"Plan Rows":54,"Plan Width":68,"Actual Startup Time":0.332,"Actual Total Time":0.364,"Actual Rows":4,"Actual Loops":1,"Group Key":["d_1.id_disciplina","u.nome"],"Plans":[{"Node Type":"Sort","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Startup Cost":129.18,"Total Cost":131.68,"Plan Rows":1000,"Plan Width":44,"Actual Startup Time":0.28,"Actual Total Time":0.283,"Actual Rows":5,"Actual Loops":1,"Sort Key":["d_1.id_disciplina","u.nome"],"Sort Method":"quicksort","Sort Space Used":25,"Sort Space Type":"Memory","Plans":[{"Node Type":"Hash Join","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Right","Startup Cost":55.15,"Total Cost":79.35,"Plan Rows":1000,"Plan Width":44,"Actual Startup Time":0.248,"Actual Total Time":0.253,"Actual Rows":5,"Actual Loops":1,"Inner Unique":false,"Hash Cond":"(a.id_aluno = u.id_usuario)","Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"avaliacao","Alias":"a","Startup Cost":0,"Total Cost":20,"Plan Rows":1000,"Plan Width":12,"Actual Startup Time":0.008,"Actual Total Time":0.009,"Actual Rows":4,"Actual Loops":1},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Startup Cost":55.04,"Total Cost":55.04,"Plan Rows":9,"Plan Width":44,"Actual Startup Time":0.218,"Actual Total Time":0.22,"Actual Rows":4,"Actual Loops":1,"Hash Buckets":1024,"Original Hash Buckets":1024,"Hash Batches":1,"Original Hash Batches":1,"Peak Memory Usage":9,"Plans":[{"Node Type":"Hash Join","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":28.72,"Total Cost":55.04,"Plan Rows":9,"Plan Width":44,"Actual Startup Time":0.204,"Actual Total Time":0.214,"Actual Rows":4,"Actual Loops":1,"Inner Unique":true,"Hash Cond":"(aet.id_aluno = u.id_usuario)","Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":27.52,"Total Cost":53.82,"Plan Rows":9,"Plan Width":16,"Actual Startup Time":0.157,"Actual Total Time":0.165,"Actual Rows":4,"Actual Loops":1,"Inner Unique":false,"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":5.49,"Total Cost":21.15,"Plan Rows":1,"Plan Width":12,"Actual Startup Time":0.144,"Actual Total Time":0.151,"Actual Rows":1,"Actual Loops":1,"Inner Unique":false,"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":5.49,"Total Cost":20.11,"Plan Rows":1,"Plan Width":16,"Actual Startup Time":0.142,"Actual Total Time":0.148,"Actual Rows":1,"Actual Loops":1,"Inner Unique":true,"Join Filter":"(ta.id_disciplina = d_1.id_disciplina)","Rows Removed by Join Filter":0,"Plans":[{"Node Type":"Hash Join","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":5.33,"Total Cost":15.92,"Plan Rows":1,"Plan Width":20,"Actual Startup Time":0.124,"Actual Total Time":0.126,"Actual Rows":5,"Actual Loops":1,"Inner Unique":false,"Hash Cond":"(pdd.id_disciplina = ta.id_disciplina)","Plans":[{"Node Type":"Bitmap Heap Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"professor_de_disciplina","Alias":"pdd","Startup Cost":4.22,"Total Cost":14.76,"Plan Rows":9,"Plan Width":8,"Actual Startup Time":0.022,"Actual Total Time":0.023,"Actual Rows":3,"Actual Loops":1,"Recheck Cond":"(id_professor = 7)","Rows Removed by Index Recheck":0,"Exact Heap Blocks":1,"Lossy Heap Blocks":0,"Plans":[{"Node Type":"Bitmap Index Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Index Name":"professor_de_disciplina_pkey","Startup Cost":0,"Total Cost":4.22,"Plan Rows":9,"Plan Width":0,"Actual Startup Time":0.016,"Actual Total Time":0.016,"Actual Rows":3,"Actual Loops":1,"Index Cond":"(id_professor = 7)"}]},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Startup Cost":1.05,"Total Cost":1.05,"Plan Rows":5,"Plan Width":12,"Actual Startup Time":0.019,"Actual Total Time":0.019,"Actual Rows":5,"Actual Loops":1,"Hash Buckets":1024,"Original Hash Buckets":1024,"Hash Batches":1,"Original Hash Batches":1,"Peak Memory Usage":9,"Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"tarefa","Alias":"ta","Startup Cost":0,"Total Cost":1.05,"Plan Rows":5,"Plan Width":12,"Actual Startup Time":0.008,"Actual Total Time":0.009,"Actual Rows":5,"Actual Loops":1}]}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"disciplina_pkey","Relation Name":"disciplina","Alias":"d_1","Startup Cost":0.15,"Total Cost":4.17,"Plan Rows":1,"Plan Width":12,"Actual Startup Time":0.004,"Actual Total Time":0.004,"Actual Rows":0,"Actual Loops":5,"Index Cond":"(id_disciplina = pdd.id_disciplina)","Rows Removed by Index Recheck":0,"Filter":"(id_turma = 1)","Rows Removed by Filter":1}]},{"Node Type":"Seq Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Relation Name":"turma","Alias":"t_2","Startup Cost":0,"Total Cost":1.04,"Plan Rows":1,"Plan Width":4,"Actual Startup Time":0.002,"Actual Total Time":0.002,"Actual Rows":1,"Actual Loops":1,"Filter":"(id_turma = 1)","Rows Removed by Filter":2}]},{"Node Type":"Bitmap Heap Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Relation Name":"aluno_em_turma","Alias":"aet","Startup Cost":22.03,"Total Cost":32.57,"Plan Rows":9,"Plan Width":16,"Actual Startup Time":0.011,"Actual Total Time":0.012,"Actual Rows":4,"Actual Loops":1,"Recheck Cond":"(id_turma = 1)","Rows Removed by Index Recheck":0,"Exact Heap Blocks":1,"Lossy Heap Blocks":0,"Plans":[{"Node Type":"Bitmap Index Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Index Name":"aluno_em_turma_pkey","Startup Cost":0,"Total Cost":22.03,"Plan Rows":9,"Plan Width":0,"Actual Startup Time":0.006,"Actual Total Time":0.006,"Actual Rows":4,"Actual Loops":1,"Index Cond":"(id_turma = 1)"}]}]},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Startup Cost":1.09,"Total Cost":1.09,"Plan Rows":9,"Plan Width":36,"Actual Startup Time":0.024,"Actual Total Time":0.024,"Actual Rows":9,"Actual Loops":1,"Hash Buckets":1024,"Original Hash Buckets":1024,"Hash Batches":1,"Original Hash Batches":1,"Peak Memory Usage":9,"Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"usuario","Alias":"u","Startup Cost":0,"Total Cost":1.09,"Plan Rows":9,"Plan Width":36,"Actual Startup Time":0.013,"Actual Total Time":0.014,"Actual Rows":9,"Actual Loops":1}]}]}]}]}]}]}]}]}]},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Startup Cost":1.03,"Total Cost":1.03,"Plan Rows":3,"Plan Width":4,"Actual Startup Time":0.014,"Actual Total Time":0.014,"Actual Rows":3,"Actual Loops":1,"Hash Buckets":1024,"Original Hash Buckets":1024,"Hash Batches":1,"Original Hash Batches":1,"Peak Memory Usage":9,"Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"turma","Alias":"t_1","Startup Cost":0,"Total Cost":1.03,"Plan Rows":3,"Plan Width":4,"Actual Startup Time":0.003,"Actual Total Time":0.003,"Actual Rows":3,"Actual Loops":1}]}]}]}]},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Startup Cost":1.03,"Total Cost":1.03,"Plan Rows":3,"Plan Width":36,"Actual Startup Time":0.033,"Actual Total Time":0.033,"Actual Rows":3,"Actual Loops":1,"Hash Buckets":1024,"Original Hash Buckets":1024,"Hash Batches":1,"Original Hash Batches":1,"Peak Memory Usage":9,"Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"turma","Alias":"t","Startup Cost":0,"Total Cost":1.03,"Plan Rows":3,"Plan Width":36,"Actual Startup Time":0.02,"Actual Total Time":0.021,"Actual Rows":3,"Actual Loops":1}]}]}]}]},"Planning Time":22.864,"Triggers":[],"Execution Time":1.338}]
 **/

-- 2
SELECT
	t.*
FROM
	tarefa t
INNER JOIN disciplina d ON
	d.id_disciplina = t.id_disciplina
INNER JOIN turma tu ON
	tu.id_turma = d.id_turma
INNER JOIN aluno_em_turma aet ON
	aet.id_turma = tu.id_turma
WHERE
	t.titulo LIKE '%Conta%'
	AND tu.ano = date_part('year', CURRENT_DATE);

/** EXPLAIN ANALYZE antes dos indices
 * [{"Plan":{"Node Type":"Nested Loop","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":0.46,"Total Cost":39.83,"Plan Rows":2,"Plan Width":113,"Actual Startup Time":4.26,"Actual Total Time":4.272,"Actual Rows":2,"Actual Loops":1,"Inner Unique":false,"Join Filter":"(tu.id_turma = aet.id_turma)","Rows Removed by Join Filter":0,"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":0.3,"Total Cost":25.55,"Plan Rows":1,"Plan Width":125,"Actual Startup Time":0.213,"Actual Total Time":0.22,"Actual Rows":1,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":0.15,"Total Cost":25.31,"Plan Rows":1,"Plan Width":121,"Actual Startup Time":0.145,"Actual Total Time":0.157,"Actual Rows":2,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"tarefa","Alias":"t","Startup Cost":0,"Total Cost":17.12,"Plan Rows":1,"Plan Width":113,"Actual Startup Time":0.077,"Actual Total Time":0.083,"Actual Rows":2,"Actual Loops":1,"Filter":"(titulo ~~ '%Conta%'::text)","Rows Removed by Filter":3},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"disciplina_pkey","Relation Name":"disciplina","Alias":"d","Startup Cost":0.15,"Total Cost":8.17,"Plan Rows":1,"Plan Width":12,"Actual Startup Time":0.033,"Actual Total Time":0.033,"Actual Rows":1,"Actual Loops":2,"Index Cond":"(id_disciplina = t.id_disciplina)","Rows Removed by Index Recheck":0}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"turma_pkey","Relation Name":"turma","Alias":"tu","Startup Cost":0.15,"Total Cost":0.22,"Plan Rows":1,"Plan Width":4,"Actual Startup Time":0.03,"Actual Total Time":0.03,"Actual Rows":0,"Actual Loops":2,"Index Cond":"(id_turma = d.id_turma)","Rows Removed by Index Recheck":0,"Filter":"((ano)::double precision = date_part('year'::text, (CURRENT_DATE)::timestamp without time zone))","Rows Removed by Filter":0}]},{"Node Type":"Index Only Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"aluno_em_turma_pkey","Relation Name":"aluno_em_turma","Alias":"aet","Startup Cost":0.15,"Total Cost":14.16,"Plan Rows":9,"Plan Width":8,"Actual Startup Time":4.042,"Actual Total Time":4.045,"Actual Rows":2,"Actual Loops":1,"Index Cond":"(id_turma = d.id_turma)","Rows Removed by Index Recheck":0,"Heap Fetches":2}]},"Planning Time":1.647,"Triggers":[],"Execution Time":4.696}]
 * EXPLAIN ANALYZE depois dos indices
 * [{"Plan":{"Node Type":"Nested Loop","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":0.43,"Total Cost":23.73,"Plan Rows":617,"Plan Width":113,"Actual Startup Time":0.203,"Actual Total Time":0.211,"Actual Rows":2,"Actual Loops":1,"Inner Unique":false,"Join Filter":"(tu.id_turma = aet.id_turma)","Rows Removed by Join Filter":0,"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":0.28,"Total Cost":9.46,"Plan Rows":1,"Plan Width":125,"Actual Startup Time":0.155,"Actual Total Time":0.159,"Actual Rows":1,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":0.15,"Total Cost":9.25,"Plan Rows":1,"Plan Width":121,"Actual Startup Time":0.046,"Actual Total Time":0.056,"Actual Rows":2,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"tarefa","Alias":"t","Startup Cost":0,"Total Cost":1.06,"Plan Rows":1,"Plan Width":113,"Actual Startup Time":0.015,"Actual Total Time":0.019,"Actual Rows":2,"Actual Loops":1,"Filter":"(titulo ~~ '%Conta%'::text)","Rows Removed by Filter":3},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"disciplina_pkey","Relation Name":"disciplina","Alias":"d","Startup Cost":0.15,"Total Cost":8.17,"Plan Rows":1,"Plan Width":12,"Actual Startup Time":0.014,"Actual Total Time":0.014,"Actual Rows":1,"Actual Loops":2,"Index Cond":"(id_disciplina = t.id_disciplina)","Rows Removed by Index Recheck":0}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"turma_pkey","Relation Name":"turma","Alias":"tu","Startup Cost":0.13,"Total Cost":0.17,"Plan Rows":1,"Plan Width":4,"Actual Startup Time":0.05,"Actual Total Time":0.05,"Actual Rows":0,"Actual Loops":2,"Index Cond":"(id_turma = d.id_turma)","Rows Removed by Index Recheck":0,"Filter":"((ano)::double precision = date_part('year'::text, (CURRENT_DATE)::timestamp without time zone))","Rows Removed by Filter":0}]},{"Node Type":"Index Only Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"aluno_em_turma_pkey","Relation Name":"aluno_em_turma","Alias":"aet","Startup Cost":0.15,"Total Cost":14.16,"Plan Rows":9,"Plan Width":8,"Actual Startup Time":0.044,"Actual Total Time":0.046,"Actual Rows":2,"Actual Loops":1,"Index Cond":"(id_turma = d.id_turma)","Rows Removed by Index Recheck":0,"Heap Fetches":2}]},"Planning Time":1.098,"Triggers":[],"Execution Time":0.433}]
 **/

-- 3

SELECT
	t.id_turma,
	t.nome,
	t.ano
FROM
	turma t
JOIN disciplina d ON
	t.id_turma = d.id_turma
JOIN professor_de_disciplina pdd ON
	d.id_disciplina = pdd.id_disciplina
WHERE
	t.ano = date_part('year', CURRENT_DATE)
	AND pdd.id_professor = :id_professor;

/** EXPLAIN ANALYZE antes dos indices
 * [{"Plan":{"Node Type":"Nested Loop","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":15.03,"Total Cost":41.2,"Plan Rows":1,"Plan Width":40,"Actual Startup Time":0.163,"Actual Total Time":0.173,"Actual Rows":2,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Hash Join","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":14.88,"Total Cost":39.15,"Plan Rows":9,"Plan Width":8,"Actual Startup Time":0.112,"Actual Total Time":0.12,"Actual Rows":3,"Actual Loops":1,"Inner Unique":true,"Hash Cond":"(d.id_disciplina = pdd.id_disciplina)","Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"disciplina","Alias":"d","Startup Cost":0,"Total Cost":21.3,"Plan Rows":1130,"Plan Width":12,"Actual Startup Time":0.012,"Actual Total Time":0.014,"Actual Rows":5,"Actual Loops":1},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Startup Cost":14.76,"Total Cost":14.76,"Plan Rows":9,"Plan Width":8,"Actual Startup Time":0.058,"Actual Total Time":0.059,"Actual Rows":3,"Actual Loops":1,"Hash Buckets":1024,"Original Hash Buckets":1024,"Hash Batches":1,"Original Hash Batches":1,"Peak Memory Usage":9,"Plans":[{"Node Type":"Bitmap Heap Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"professor_de_disciplina","Alias":"pdd","Startup Cost":4.22,"Total Cost":14.76,"Plan Rows":9,"Plan Width":8,"Actual Startup Time":0.032,"Actual Total Time":0.034,"Actual Rows":3,"Actual Loops":1,"Recheck Cond":"(id_professor = 7)","Rows Removed by Index Recheck":0,"Exact Heap Blocks":1,"Lossy Heap Blocks":0,"Plans":[{"Node Type":"Bitmap Index Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Index Name":"professor_de_disciplina_pkey","Startup Cost":0,"Total Cost":4.22,"Plan Rows":9,"Plan Width":0,"Actual Startup Time":0.024,"Actual Total Time":0.024,"Actual Rows":3,"Actual Loops":1,"Index Cond":"(id_professor = 7)"}]}]}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"turma_pkey","Relation Name":"turma","Alias":"t","Startup Cost":0.15,"Total Cost":0.22,"Plan Rows":1,"Plan Width":40,"Actual Startup Time":0.015,"Actual Total Time":0.015,"Actual Rows":1,"Actual Loops":3,"Index Cond":"(id_turma = d.id_turma)","Rows Removed by Index Recheck":0,"Filter":"((ano)::double precision = date_part('year'::text, (CURRENT_DATE)::timestamp without time zone))","Rows Removed by Filter":0}]},"Planning Time":0.435,"Triggers":[],"Execution Time":0.473}]
 * EXPLAIN ANALYZE depois dos indices
 * [{"Plan":{"Node Type":"Nested Loop","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":0.43,"Total Cost":23.73,"Plan Rows":617,"Plan Width":113,"Actual Startup Time":0.203,"Actual Total Time":0.211,"Actual Rows":2,"Actual Loops":1,"Inner Unique":false,"Join Filter":"(tu.id_turma = aet.id_turma)","Rows Removed by Join Filter":0,"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":0.28,"Total Cost":9.46,"Plan Rows":1,"Plan Width":125,"Actual Startup Time":0.155,"Actual Total Time":0.159,"Actual Rows":1,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":0.15,"Total Cost":9.25,"Plan Rows":1,"Plan Width":121,"Actual Startup Time":0.046,"Actual Total Time":0.056,"Actual Rows":2,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"tarefa","Alias":"t","Startup Cost":0,"Total Cost":1.06,"Plan Rows":1,"Plan Width":113,"Actual Startup Time":0.015,"Actual Total Time":0.019,"Actual Rows":2,"Actual Loops":1,"Filter":"(titulo ~~ '%Conta%'::text)","Rows Removed by Filter":3},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"disciplina_pkey","Relation Name":"disciplina","Alias":"d","Startup Cost":0.15,"Total Cost":8.17,"Plan Rows":1,"Plan Width":12,"Actual Startup Time":0.014,"Actual Total Time":0.014,"Actual Rows":1,"Actual Loops":2,"Index Cond":"(id_disciplina = t.id_disciplina)","Rows Removed by Index Recheck":0}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"turma_pkey","Relation Name":"turma","Alias":"tu","Startup Cost":0.13,"Total Cost":0.17,"Plan Rows":1,"Plan Width":4,"Actual Startup Time":0.05,"Actual Total Time":0.05,"Actual Rows":0,"Actual Loops":2,"Index Cond":"(id_turma = d.id_turma)","Rows Removed by Index Recheck":0,"Filter":"((ano)::double precision = date_part('year'::text, (CURRENT_DATE)::timestamp without time zone))","Rows Removed by Filter":0}]},{"Node Type":"Index Only Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"aluno_em_turma_pkey","Relation Name":"aluno_em_turma","Alias":"aet","Startup Cost":0.15,"Total Cost":14.16,"Plan Rows":9,"Plan Width":8,"Actual Startup Time":0.044,"Actual Total Time":0.046,"Actual Rows":2,"Actual Loops":1,"Index Cond":"(id_turma = d.id_turma)","Rows Removed by Index Recheck":0,"Heap Fetches":2}]},"Planning Time":1.098,"Triggers":[],"Execution Time":0.433}]
 **/

-- 4

SELECT
	t.id_turma,
	t.nome,
	t.ano
FROM
	turma t
JOIN aluno_em_turma aet ON
	aet.id_turma = t.id_turma
WHERE
	t.ano = date_part('year', CURRENT_DATE)
	AND aet.id_aluno = :id_aluno;

/** EXPLAIN ANALYZE antes dos indices
 * [{"Plan":{"Node Type":"Hash Join","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":14.88,"Total Cost":51.89,"Plan Rows":1,"Plan Width":40,"Actual Startup Time":0.389,"Actual Total Time":0.393,"Actual Rows":1,"Actual Loops":1,"Inner Unique":true,"Hash Cond":"(t.id_turma = aet.id_turma)","Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"turma","Alias":"t","Startup Cost":0,"Total Cost":37,"Plan Rows":6,"Plan Width":40,"Actual Startup Time":0.089,"Actual Total Time":0.091,"Actual Rows":2,"Actual Loops":1,"Filter":"((ano)::double precision = date_part('year'::text, (CURRENT_DATE)::timestamp without time zone))","Rows Removed by Filter":1},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Startup Cost":14.76,"Total Cost":14.76,"Plan Rows":9,"Plan Width":8,"Actual Startup Time":0.069,"Actual Total Time":0.07,"Actual Rows":2,"Actual Loops":1,"Hash Buckets":1024,"Original Hash Buckets":1024,"Hash Batches":1,"Original Hash Batches":1,"Peak Memory Usage":9,"Plans":[{"Node Type":"Bitmap Heap Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"aluno_em_turma","Alias":"aet","Startup Cost":4.22,"Total Cost":14.76,"Plan Rows":9,"Plan Width":8,"Actual Startup Time":0.053,"Actual Total Time":0.054,"Actual Rows":2,"Actual Loops":1,"Recheck Cond":"(id_aluno = 4)","Rows Removed by Index Recheck":0,"Exact Heap Blocks":1,"Lossy Heap Blocks":0,"Plans":[{"Node Type":"Bitmap Index Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Index Name":"aluno_em_turma_pkey","Startup Cost":0,"Total Cost":4.22,"Plan Rows":9,"Plan Width":0,"Actual Startup Time":0.041,"Actual Total Time":0.041,"Actual Rows":2,"Actual Loops":1,"Index Cond":"(id_aluno = 4)"}]}]}]},"Planning Time":7.918,"Triggers":[],"Execution Time":0.548}]
 * EXPLAIN ANALYZE depois dos indices
 * [{"Plan":{"Node Type":"Nested Loop","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":0.15,"Total Cost":10.84,"Plan Rows":3,"Plan Width":40,"Actual Startup Time":0.114,"Actual Total Time":0.12,"Actual Rows":1,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"turma","Alias":"t","Startup Cost":0,"Total Cost":1.07,"Plan Rows":1,"Plan Width":40,"Actual Startup Time":0.044,"Actual Total Time":0.046,"Actual Rows":2,"Actual Loops":1,"Filter":"((ano)::double precision = date_part('year'::text, (CURRENT_DATE)::timestamp without time zone))","Rows Removed by Filter":1},{"Node Type":"Index Only Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"aluno_em_turma_pkey","Relation Name":"aluno_em_turma","Alias":"aet","Startup Cost":0.15,"Total Cost":8.17,"Plan Rows":1,"Plan Width":8,"Actual Startup Time":0.035,"Actual Total Time":0.035,"Actual Rows":0,"Actual Loops":2,"Index Cond":"((id_aluno = 4) AND (id_turma = t.id_turma))","Rows Removed by Index Recheck":0,"Heap Fetches":1}]},"Planning Time":0.5,"Triggers":[],"Execution Time":0.266}]
 **/

-- 5
SELECT u.id_usuario AS aluno_id
      , u.nome AS aluno_nome
      , e.conteudo
      , e.data_hora
      , e.em_definitivo
      , a.visto
      , a.nota
      , a.comentario
      , (a.visto IS NULL AND a.nota IS NULL) AS avaliacao_pendente
      , (e.id_aluno IS NOT NULL) as entrega_feita
      , (a.id_aluno IS NOT NULL) as avaliacao_feita
  FROM usuario u
  JOIN aluno_em_turma aet
    ON aet.id_aluno = u.id_usuario
    AND aet.id_turma = :idTurma
LEFT JOIN entrega e
    ON e.id_aluno = u.id_usuario
    AND e.id_tarefa = :idTarefa
LEFT JOIN avaliacao a
    ON a.id_aluno = u.id_usuario
    AND a.id_Tarefa = :idTarefa
ORDER BY e.em_definitivo, avaliacao_pendente DESC;

/** EXPLAIN ANALYZE antes dos indices
 * [{"Plan":{"Node Type":"Sort","Parallel Aware":false,"Async Capable":false,"Startup Cost":54.48,"Total Cost":54.51,"Plan Rows":9,"Plan Width":117,"Actual Startup Time":0.089,"Actual Total Time":0.091,"Actual Rows":0,"Actual Loops":1,"Sort Key":["e.em_definitivo","(((a.visto IS NULL) AND (a.nota IS NULL))) DESC"],"Sort Method":"quicksort","Sort Space Used":25,"Sort Space Type":"Memory","Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Left","Startup Cost":32.98,"Total Cost":54.34,"Plan Rows":9,"Plan Width":117,"Actual Startup Time":0.027,"Actual Total Time":0.028,"Actual Rows":0,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Left","Startup Cost":32.83,"Total Cost":51.99,"Plan Rows":9,"Plan Width":85,"Actual Startup Time":0.027,"Actual Total Time":0.028,"Actual Rows":0,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Hash Join","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":32.68,"Total Cost":49.64,"Plan Rows":9,"Plan Width":36,"Actual Startup Time":0.027,"Actual Total Time":0.028,"Actual Rows":0,"Actual Loops":1,"Inner Unique":true,"Hash Cond":"(u.id_usuario = aet.id_aluno)","Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"usuario","Alias":"u","Startup Cost":0,"Total Cost":15.5,"Plan Rows":550,"Plan Width":36,"Actual Startup Time":0.003,"Actual Total Time":0.003,"Actual Rows":1,"Actual Loops":1},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Startup Cost":32.57,"Total Cost":32.57,"Plan Rows":9,"Plan Width":8,"Actual Startup Time":0.004,"Actual Total Time":0.004,"Actual Rows":0,"Actual Loops":1,"Hash Buckets":1024,"Original Hash Buckets":1024,"Hash Batches":1,"Original Hash Batches":1,"Peak Memory Usage":8,"Plans":[{"Node Type":"Bitmap Heap Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"aluno_em_turma","Alias":"aet","Startup Cost":22.03,"Total Cost":32.57,"Plan Rows":9,"Plan Width":8,"Actual Startup Time":0.003,"Actual Total Time":0.004,"Actual Rows":0,"Actual Loops":1,"Recheck Cond":"(id_turma = 7)","Rows Removed by Index Recheck":0,"Exact Heap Blocks":0,"Lossy Heap Blocks":0,"Plans":[{"Node Type":"Bitmap Index Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Index Name":"aluno_em_turma_pkey","Startup Cost":0,"Total Cost":22.03,"Plan Rows":9,"Plan Width":0,"Actual Startup Time":0.002,"Actual Total Time":0.002,"Actual Rows":0,"Actual Loops":1,"Index Cond":"(id_turma = 7)"}]}]}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"entrega_pkey","Relation Name":"entrega","Alias":"e","Startup Cost":0.15,"Total Cost":0.26,"Plan Rows":1,"Plan Width":49,"Actual Startup Time":0,"Actual Total Time":0,"Actual Rows":0,"Actual Loops":0,"Index Cond":"((id_tarefa = 4) AND (id_aluno = u.id_usuario))","Rows Removed by Index Recheck":0}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"avaliacao_pkey","Relation Name":"avaliacao","Alias":"a","Startup Cost":0.15,"Total Cost":0.26,"Plan Rows":1,"Plan Width":45,"Actual Startup Time":0,"Actual Total Time":0,"Actual Rows":0,"Actual Loops":0,"Index Cond":"((id_tarefa = 4) AND (id_aluno = u.id_usuario))","Rows Removed by Index Recheck":0}]}]},"Planning Time":21.344,"Triggers":[],"Execution Time":0.218}]
 * EXPLAIN ANALYZE depois dos indices
 * [{"Plan":{"Node Type":"Sort","Parallel Aware":false,"Async Capable":false,"Startup Cost":59.44,"Total Cost":59.46,"Plan Rows":9,"Plan Width":117,"Actual Startup Time":0.069,"Actual Total Time":0.071,"Actual Rows":0,"Actual Loops":1,"Sort Key":["e.em_definitivo","(((a.visto IS NULL) AND (a.nota IS NULL))) DESC"],"Sort Method":"quicksort","Sort Space Used":25,"Sort Space Type":"Memory","Plans":[{"Node Type":"Hash Join","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Left","Startup Cost":48.68,"Total Cost":59.29,"Plan Rows":9,"Plan Width":117,"Actual Startup Time":0.045,"Actual Total Time":0.047,"Actual Rows":0,"Actual Loops":1,"Inner Unique":true,"Hash Cond":"(u.id_usuario = a.id_aluno)","Plans":[{"Node Type":"Hash Join","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Left","Startup Cost":35.96,"Total Cost":46.55,"Plan Rows":9,"Plan Width":85,"Actual Startup Time":0.045,"Actual Total Time":0.046,"Actual Rows":0,"Actual Loops":1,"Inner Unique":true,"Hash Cond":"(u.id_usuario = e.id_aluno)","Plans":[{"Node Type":"Hash Join","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":23.23,"Total Cost":33.8,"Plan Rows":9,"Plan Width":36,"Actual Startup Time":0.044,"Actual Total Time":0.045,"Actual Rows":0,"Actual Loops":1,"Inner Unique":true,"Hash Cond":"(aet.id_aluno = u.id_usuario)","Plans":[{"Node Type":"Bitmap Heap Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"aluno_em_turma","Alias":"aet","Startup Cost":22.03,"Total Cost":32.57,"Plan Rows":9,"Plan Width":8,"Actual Startup Time":0.008,"Actual Total Time":0.008,"Actual Rows":0,"Actual Loops":1,"Recheck Cond":"(id_turma = 7)","Rows Removed by Index Recheck":0,"Exact Heap Blocks":0,"Lossy Heap Blocks":0,"Plans":[{"Node Type":"Bitmap Index Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Index Name":"aluno_em_turma_pkey","Startup Cost":0,"Total Cost":22.03,"Plan Rows":9,"Plan Width":0,"Actual Startup Time":0.006,"Actual Total Time":0.006,"Actual Rows":0,"Actual Loops":1,"Index Cond":"(id_turma = 7)"}]},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Startup Cost":1.09,"Total Cost":1.09,"Plan Rows":9,"Plan Width":36,"Actual Startup Time":0.023,"Actual Total Time":0.024,"Actual Rows":9,"Actual Loops":1,"Hash Buckets":1024,"Original Hash Buckets":1024,"Hash Batches":1,"Original Hash Batches":1,"Peak Memory Usage":9,"Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"usuario","Alias":"u","Startup Cost":0,"Total Cost":1.09,"Plan Rows":9,"Plan Width":36,"Actual Startup Time":0.011,"Actual Total Time":0.013,"Actual Rows":9,"Actual Loops":1}]}]},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Startup Cost":12.66,"Total Cost":12.66,"Plan Rows":5,"Plan Width":49,"Actual Startup Time":0,"Actual Total Time":0,"Actual Rows":0,"Actual Loops":0,"Plans":[{"Node Type":"Bitmap Heap Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"entrega","Alias":"e","Startup Cost":4.19,"Total Cost":12.66,"Plan Rows":5,"Plan Width":49,"Actual Startup Time":0,"Actual Total Time":0,"Actual Rows":0,"Actual Loops":0,"Recheck Cond":"(id_tarefa = 4)","Rows Removed by Index Recheck":0,"Exact Heap Blocks":0,"Lossy Heap Blocks":0,"Plans":[{"Node Type":"Bitmap Index Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Index Name":"entrega_pkey","Startup Cost":0,"Total Cost":4.19,"Plan Rows":5,"Plan Width":0,"Actual Startup Time":0,"Actual Total Time":0,"Actual Rows":0,"Actual Loops":0,"Index Cond":"(id_tarefa = 4)"}]}]}]},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Startup Cost":12.66,"Total Cost":12.66,"Plan Rows":5,"Plan Width":45,"Actual Startup Time":0,"Actual Total Time":0,"Actual Rows":0,"Actual Loops":0,"Plans":[{"Node Type":"Bitmap Heap Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"avaliacao","Alias":"a","Startup Cost":4.19,"Total Cost":12.66,"Plan Rows":5,"Plan Width":45,"Actual Startup Time":0,"Actual Total Time":0,"Actual Rows":0,"Actual Loops":0,"Recheck Cond":"(id_tarefa = 4)","Rows Removed by Index Recheck":0,"Exact Heap Blocks":0,"Lossy Heap Blocks":0,"Plans":[{"Node Type":"Bitmap Index Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Index Name":"avaliacao_pkey","Startup Cost":0,"Total Cost":4.19,"Plan Rows":5,"Plan Width":0,"Actual Startup Time":0,"Actual Total Time":0,"Actual Rows":0,"Actual Loops":0,"Index Cond":"(id_tarefa = 4)"}]}]}]}]},"Planning Time":0.656,"Triggers":[],"Execution Time":0.465}]
 **/

-- 6
SELECT ta.id_professor
    , ta.fechamento < CURRENT_TIMESTAMP AS fechada
    , ta.abertura <= CURRENT_TIMESTAMP AS aberta
    , di.id_disciplina
    , tu.id_turma
    , tu.ano != :ano AS arquivada
    , EXISTS(SELECT 1 FROM entrega WHERE id_tarefa = :id) as tem_entregas
  FROM tarefa ta
  JOIN disciplina di ON ta.id_disciplina = di.id_disciplina
  JOIN turma tu ON di.id_turma = tu.id_turma
WHERE ta.id_tarefa = :id;

/** EXPLAIN ANALYZE antes dos indices
 * [{"Plan":{"Node Type":"Nested Loop","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":4.62,"Total Cost":20.74,"Plan Rows":1,"Plan Width":20,"Actual Startup Time":0.305,"Actual Total Time":0.307,"Actual Rows":1,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Index Only Scan","Parent Relationship":"InitPlan","Subplan Name":"InitPlan 1 (returns $0)","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"entrega_pkey","Relation Name":"entrega","Alias":"entrega","Startup Cost":0.15,"Total Cost":20.24,"Plan Rows":5,"Plan Width":0,"Actual Startup Time":0.052,"Actual Total Time":0.053,"Actual Rows":0,"Actual Loops":1,"Index Cond":"(id_tarefa = 3)","Rows Removed by Index Recheck":0,"Heap Fetches":0},{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":0.3,"Total Cost":16.35,"Plan Rows":1,"Plan Width":36,"Actual Startup Time":0.2,"Actual Total Time":0.201,"Actual Rows":1,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Index Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"tarefa_pkey","Relation Name":"tarefa","Alias":"ta","Startup Cost":0.15,"Total Cost":8.17,"Plan Rows":1,"Plan Width":32,"Actual Startup Time":0.142,"Actual Total Time":0.142,"Actual Rows":1,"Actual Loops":1,"Index Cond":"(id_tarefa = 3)","Rows Removed by Index Recheck":0},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"disciplina_pkey","Relation Name":"disciplina","Alias":"di","Startup Cost":0.15,"Total Cost":8.17,"Plan Rows":1,"Plan Width":12,"Actual Startup Time":0.046,"Actual Total Time":0.047,"Actual Rows":1,"Actual Loops":1,"Index Cond":"(id_disciplina = ta.id_disciplina)","Rows Removed by Index Recheck":0}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"turma_pkey","Relation Name":"turma","Alias":"tu","Startup Cost":0.15,"Total Cost":0.21,"Plan Rows":1,"Plan Width":8,"Actual Startup Time":0.033,"Actual Total Time":0.033,"Actual Rows":1,"Actual Loops":1,"Index Cond":"(id_turma = di.id_turma)","Rows Removed by Index Recheck":0}]},"Planning Time":10.055,"Triggers":[],"Execution Time":0.501}]
 * EXPLAIN ANALYZE depois dos indices
 * [{"Plan":{"Node Type":"Nested Loop","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":4.45,"Total Cost":13.6,"Plan Rows":1,"Plan Width":20,"Actual Startup Time":0.183,"Actual Total Time":0.186,"Actual Rows":1,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Index Only Scan","Parent Relationship":"InitPlan","Subplan Name":"InitPlan 1 (returns $0)","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"entrega_pkey","Relation Name":"entrega","Alias":"entrega","Startup Cost":0.15,"Total Cost":20.24,"Plan Rows":5,"Plan Width":0,"Actual Startup Time":0.035,"Actual Total Time":0.035,"Actual Rows":0,"Actual Loops":1,"Index Cond":"(id_tarefa = 3)","Rows Removed by Index Recheck":0,"Heap Fetches":0},{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":0.15,"Total Cost":9.25,"Plan Rows":1,"Plan Width":36,"Actual Startup Time":0.103,"Actual Total Time":0.104,"Actual Rows":1,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"tarefa","Alias":"ta","Startup Cost":0,"Total Cost":1.06,"Plan Rows":1,"Plan Width":32,"Actual Startup Time":0.055,"Actual Total Time":0.056,"Actual Rows":1,"Actual Loops":1,"Filter":"(id_tarefa = 3)","Rows Removed by Filter":4},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"disciplina_pkey","Relation Name":"disciplina","Alias":"di","Startup Cost":0.15,"Total Cost":8.17,"Plan Rows":1,"Plan Width":12,"Actual Startup Time":0.043,"Actual Total Time":0.043,"Actual Rows":1,"Actual Loops":1,"Index Cond":"(id_disciplina = ta.id_disciplina)","Rows Removed by Index Recheck":0}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"turma_pkey","Relation Name":"turma","Alias":"tu","Startup Cost":0.13,"Total Cost":0.16,"Plan Rows":1,"Plan Width":8,"Actual Startup Time":0.02,"Actual Total Time":0.02,"Actual Rows":1,"Actual Loops":1,"Index Cond":"(id_turma = di.id_turma)","Rows Removed by Index Recheck":0}]},"Planning Time":10.541,"Triggers":[],"Execution Time":0.546}]
 **/

-- 7

SELECT
	*
FROM
	usuario u
WHERE
	tipo = 'aluno'
	AND nome LIKE '%jose%';

/** EXPLAIN ANALYZE antes dos indices
 * [{"Plan":{"Node Type":"Seq Scan","Parallel Aware":false,"Async Capable":false,"Relation Name":"usuario","Alias":"u","Startup Cost":0,"Total Cost":18.25,"Plan Rows":1,"Plan Width":120,"Actual Startup Time":0.022,"Actual Total Time":0.022,"Actual Rows":0,"Actual Loops":1,"Filter":"((nome ~~ '%jose%'::text) AND (tipo = 'aluno'::tipo_usuario))","Rows Removed by Filter":9},"Planning Time":0.175,"Triggers":[],"Execution Time":0.044}]
 * EXPLAIN ANALYZE depois dos indices
 *  [{"Plan":{"Node Type":"Seq Scan","Parallel Aware":false,"Async Capable":false,"Relation Name":"usuario","Alias":"u","Startup Cost":0,"Total Cost":1.14,"Plan Rows":1,"Plan Width":120,"Actual Startup Time":0.023,"Actual Total Time":0.024,"Actual Rows":0,"Actual Loops":1,"Filter":"((nome ~~ '%jose%'::text) AND (tipo = 'aluno'::tipo_usuario))","Rows Removed by Filter":9},"Planning Time":0.205,"Triggers":[],"Execution Time":0.046}]
 **/

-- 8

SELECT ta.id_tarefa
      , pro.id_usuario AS id_professor
      , pro.nome AS nome_professor
      , di.id_disciplina
      , di.nome AS nome_disciplina
      , tu.id_turma
      , tu.nome AS nome_turma
      , tu.ano AS turma_ano
      , ta.titulo
      , ta.descricao
      , ta.esforco_minutos
      , ta.com_nota
      , ta.abertura
      , ta.entrega
      , ta.fechamento
   FROM tarefa ta
   JOIN usuario pro ON ta.id_professor = pro.id_usuario
   JOIN disciplina di ON ta.id_disciplina = di.id_disciplina
   JOIN turma tu ON di.id_turma = tu.id_turma
   JOIN professor_de_disciplina pdd on di.id_disciplina = pdd.id_disciplina
  WHERE pdd.id_professor = :id_professor
    AND tu.id_turma = :id_turma;

/** EXPLAIN ANALYZE antes dos indices
 * [{"Plan":{"Node Type":"Nested Loop","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":15.33,"Total Cost":47.24,"Plan Rows":1,"Plan Width":209,"Actual Startup Time":0.688,"Actual Total Time":0.708,"Actual Rows":1,"Actual Loops":1,"Inner Unique":false,"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":15.18,"Total Cost":39.06,"Plan Rows":1,"Plan Width":177,"Actual Startup Time":0.653,"Actual Total Time":0.671,"Actual Rows":1,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":15.03,"Total Cost":38.81,"Plan Rows":1,"Plan Width":149,"Actual Startup Time":0.276,"Actual Total Time":0.294,"Actual Rows":1,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Hash Join","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":14.88,"Total Cost":32.11,"Plan Rows":26,"Plan Width":121,"Actual Startup Time":0.229,"Actual Total Time":0.236,"Actual Rows":5,"Actual Loops":1,"Inner Unique":true,"Hash Cond":"(ta.id_disciplina = pdd.id_disciplina)","Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"tarefa","Alias":"ta","Startup Cost":0,"Total Cost":15.7,"Plan Rows":570,"Plan Width":113,"Actual Startup Time":0.037,"Actual Total Time":0.038,"Actual Rows":5,"Actual Loops":1},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Startup Cost":14.76,"Total Cost":14.76,"Plan Rows":9,"Plan Width":8,"Actual Startup Time":0.128,"Actual Total Time":0.129,"Actual Rows":3,"Actual Loops":1,"Hash Buckets":1024,"Original Hash Buckets":1024,"Hash Batches":1,"Original Hash Batches":1,"Peak Memory Usage":9,"Plans":[{"Node Type":"Bitmap Heap Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"professor_de_disciplina","Alias":"pdd","Startup Cost":4.22,"Total Cost":14.76,"Plan Rows":9,"Plan Width":8,"Actual Startup Time":0.088,"Actual Total Time":0.09,"Actual Rows":3,"Actual Loops":1,"Recheck Cond":"(id_professor = 7)","Rows Removed by Index Recheck":0,"Exact Heap Blocks":1,"Lossy Heap Blocks":0,"Plans":[{"Node Type":"Bitmap Index Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Index Name":"professor_de_disciplina_pkey","Startup Cost":0,"Total Cost":4.22,"Plan Rows":9,"Plan Width":0,"Actual Startup Time":0.048,"Actual Total Time":0.048,"Actual Rows":3,"Actual Loops":1,"Index Cond":"(id_professor = 7)"}]}]}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"disciplina_pkey","Relation Name":"disciplina","Alias":"di","Startup Cost":0.15,"Total Cost":0.26,"Plan Rows":1,"Plan Width":44,"Actual Startup Time":0.009,"Actual Total Time":0.009,"Actual Rows":0,"Actual Loops":5,"Index Cond":"(id_disciplina = ta.id_disciplina)","Rows Removed by Index Recheck":0,"Filter":"(id_turma = 1)","Rows Removed by Filter":1}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"usuario_pkey","Relation Name":"usuario","Alias":"pro","Startup Cost":0.15,"Total Cost":0.25,"Plan Rows":1,"Plan Width":36,"Actual Startup Time":0.373,"Actual Total Time":0.373,"Actual Rows":1,"Actual Loops":1,"Index Cond":"(id_usuario = ta.id_professor)","Rows Removed by Index Recheck":0}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"turma_pkey","Relation Name":"turma","Alias":"tu","Startup Cost":0.15,"Total Cost":8.17,"Plan Rows":1,"Plan Width":40,"Actual Startup Time":0.033,"Actual Total Time":0.034,"Actual Rows":1,"Actual Loops":1,"Index Cond":"(id_turma = 1)","Rows Removed by Index Recheck":0}]},"Planning Time":8.448,"Triggers":[],"Execution Time":1.147}]
 * EXPLAIN ANALYZE depois dos indices
 * [{"Plan":{"Node Type":"Nested Loop","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":5.49,"Total Cost":22.36,"Plan Rows":1,"Plan Width":209,"Actual Startup Time":0.449,"Actual Total Time":0.511,"Actual Rows":1,"Actual Loops":1,"Inner Unique":false,"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":5.49,"Total Cost":21.31,"Plan Rows":1,"Plan Width":177,"Actual Startup Time":0.418,"Actual Total Time":0.476,"Actual Rows":1,"Actual Loops":1,"Inner Unique":true,"Join Filter":"(ta.id_disciplina = di.id_disciplina)","Rows Removed by Join Filter":0,"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":5.33,"Total Cost":17.12,"Plan Rows":1,"Plan Width":149,"Actual Startup Time":0.34,"Actual Total Time":0.374,"Actual Rows":5,"Actual Loops":1,"Inner Unique":true,"Join Filter":"(ta.id_professor = pro.id_usuario)","Rows Removed by Join Filter":20,"Plans":[{"Node Type":"Hash Join","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":5.33,"Total Cost":15.92,"Plan Rows":1,"Plan Width":121,"Actual Startup Time":0.314,"Actual Total Time":0.324,"Actual Rows":5,"Actual Loops":1,"Inner Unique":false,"Hash Cond":"(pdd.id_disciplina = ta.id_disciplina)","Plans":[{"Node Type":"Bitmap Heap Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"professor_de_disciplina","Alias":"pdd","Startup Cost":4.22,"Total Cost":14.76,"Plan Rows":9,"Plan Width":8,"Actual Startup Time":0.125,"Actual Total Time":0.127,"Actual Rows":3,"Actual Loops":1,"Recheck Cond":"(id_professor = 7)","Rows Removed by Index Recheck":0,"Exact Heap Blocks":1,"Lossy Heap Blocks":0,"Plans":[{"Node Type":"Bitmap Index Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Index Name":"professor_de_disciplina_pkey","Startup Cost":0,"Total Cost":4.22,"Plan Rows":9,"Plan Width":0,"Actual Startup Time":0.079,"Actual Total Time":0.08,"Actual Rows":3,"Actual Loops":1,"Index Cond":"(id_professor = 7)"}]},{"Node Type":"Hash","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Startup Cost":1.05,"Total Cost":1.05,"Plan Rows":5,"Plan Width":113,"Actual Startup Time":0.119,"Actual Total Time":0.12,"Actual Rows":5,"Actual Loops":1,"Hash Buckets":1024,"Original Hash Buckets":1024,"Hash Batches":1,"Original Hash Batches":1,"Peak Memory Usage":9,"Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"tarefa","Alias":"ta","Startup Cost":0,"Total Cost":1.05,"Plan Rows":5,"Plan Width":113,"Actual Startup Time":0.081,"Actual Total Time":0.086,"Actual Rows":5,"Actual Loops":1}]}]},{"Node Type":"Seq Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Relation Name":"usuario","Alias":"pro","Startup Cost":0,"Total Cost":1.09,"Plan Rows":9,"Plan Width":36,"Actual Startup Time":0.005,"Actual Total Time":0.006,"Actual Rows":5,"Actual Loops":5}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"disciplina_pkey","Relation Name":"disciplina","Alias":"di","Startup Cost":0.15,"Total Cost":4.17,"Plan Rows":1,"Plan Width":44,"Actual Startup Time":0.017,"Actual Total Time":0.017,"Actual Rows":0,"Actual Loops":5,"Index Cond":"(id_disciplina = pdd.id_disciplina)","Rows Removed by Index Recheck":0,"Filter":"(id_turma = 1)","Rows Removed by Filter":1}]},{"Node Type":"Seq Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Relation Name":"turma","Alias":"tu","Startup Cost":0,"Total Cost":1.04,"Plan Rows":1,"Plan Width":40,"Actual Startup Time":0.028,"Actual Total Time":0.03,"Actual Rows":1,"Actual Loops":1,"Filter":"(id_turma = 1)","Rows Removed by Filter":2}]},"Planning Time":1.551,"Triggers":[],"Execution Time":1.209}]
 **/

-- 9
SELECT ta.id_tarefa
    , pro.id_usuario AS id_professor
    , pro.nome AS nome_professor
    , di.id_disciplina
    , di.nome AS nome_disciplina
    , tu.id_turma
    , tu.nome AS nome_turma
    , tu.ano AS turma_ano
    , ta.titulo
    , ta.descricao
    , ta.esforco_minutos
    , ta.com_nota
    , ta.abertura
    , ta.entrega
    , ta.fechamento
  FROM tarefa ta
  JOIN usuario pro ON ta.id_professor = pro.id_usuario
  JOIN disciplina di ON ta.id_disciplina = di.id_disciplina
  JOIN turma tu ON di.id_turma = tu.id_turma
  WHERE id_tarefa = :id;

/** EXPLAIN ANALYZE antes dos indices
 * [{"Plan":{"Node Type":"Nested Loop","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":0.6,"Total Cost":24.76,"Plan Rows":1,"Plan Width":209,"Actual Startup Time":0.225,"Actual Total Time":0.23,"Actual Rows":1,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":0.45,"Total Cost":24.55,"Plan Rows":1,"Plan Width":177,"Actual Startup Time":0.195,"Actual Total Time":0.199,"Actual Rows":1,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":0.3,"Total Cost":16.36,"Plan Rows":1,"Plan Width":141,"Actual Startup Time":0.119,"Actual Total Time":0.122,"Actual Rows":1,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Index Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"tarefa_pkey","Relation Name":"tarefa","Alias":"ta","Startup Cost":0.15,"Total Cost":8.17,"Plan Rows":1,"Plan Width":113,"Actual Startup Time":0.067,"Actual Total Time":0.069,"Actual Rows":1,"Actual Loops":1,"Index Cond":"(id_tarefa = 3)","Rows Removed by Index Recheck":0},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"usuario_pkey","Relation Name":"usuario","Alias":"pro","Startup Cost":0.15,"Total Cost":8.17,"Plan Rows":1,"Plan Width":36,"Actual Startup Time":0.042,"Actual Total Time":0.042,"Actual Rows":1,"Actual Loops":1,"Index Cond":"(id_usuario = ta.id_professor)","Rows Removed by Index Recheck":0}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"disciplina_pkey","Relation Name":"disciplina","Alias":"di","Startup Cost":0.15,"Total Cost":8.17,"Plan Rows":1,"Plan Width":44,"Actual Startup Time":0.023,"Actual Total Time":0.023,"Actual Rows":1,"Actual Loops":1,"Index Cond":"(id_disciplina = ta.id_disciplina)","Rows Removed by Index Recheck":0}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"turma_pkey","Relation Name":"turma","Alias":"tu","Startup Cost":0.15,"Total Cost":0.21,"Plan Rows":1,"Plan Width":40,"Actual Startup Time":0.026,"Actual Total Time":0.026,"Actual Rows":1,"Actual Loops":1,"Index Cond":"(id_turma = di.id_turma)","Rows Removed by Index Recheck":0}]},"Planning Time":0.515,"Triggers":[],"Execution Time":0.455}]
 * EXPLAIN ANALYZE depois dos indices
 * [{"Plan":{"Node Type":"Nested Loop","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":0.28,"Total Cost":10.62,"Plan Rows":1,"Plan Width":209,"Actual Startup Time":0.165,"Actual Total Time":0.17,"Actual Rows":1,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":0.15,"Total Cost":10.45,"Plan Rows":1,"Plan Width":177,"Actual Startup Time":0.111,"Actual Total Time":0.114,"Actual Rows":1,"Actual Loops":1,"Inner Unique":true,"Join Filter":"(ta.id_professor = pro.id_usuario)","Rows Removed by Join Filter":4,"Plans":[{"Node Type":"Nested Loop","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Join Type":"Inner","Startup Cost":0.15,"Total Cost":9.25,"Plan Rows":1,"Plan Width":149,"Actual Startup Time":0.091,"Actual Total Time":0.094,"Actual Rows":1,"Actual Loops":1,"Inner Unique":true,"Plans":[{"Node Type":"Seq Scan","Parent Relationship":"Outer","Parallel Aware":false,"Async Capable":false,"Relation Name":"tarefa","Alias":"ta","Startup Cost":0,"Total Cost":1.06,"Plan Rows":1,"Plan Width":113,"Actual Startup Time":0.018,"Actual Total Time":0.02,"Actual Rows":1,"Actual Loops":1,"Filter":"(id_tarefa = 3)","Rows Removed by Filter":4},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"disciplina_pkey","Relation Name":"disciplina","Alias":"di","Startup Cost":0.15,"Total Cost":8.17,"Plan Rows":1,"Plan Width":44,"Actual Startup Time":0.066,"Actual Total Time":0.066,"Actual Rows":1,"Actual Loops":1,"Index Cond":"(id_disciplina = ta.id_disciplina)","Rows Removed by Index Recheck":0}]},{"Node Type":"Seq Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Relation Name":"usuario","Alias":"pro","Startup Cost":0,"Total Cost":1.09,"Plan Rows":9,"Plan Width":36,"Actual Startup Time":0.014,"Actual Total Time":0.015,"Actual Rows":5,"Actual Loops":1}]},{"Node Type":"Index Scan","Parent Relationship":"Inner","Parallel Aware":false,"Async Capable":false,"Scan Direction":"Forward","Index Name":"turma_pkey","Relation Name":"turma","Alias":"tu","Startup Cost":0.13,"Total Cost":0.16,"Plan Rows":1,"Plan Width":40,"Actual Startup Time":0.051,"Actual Total Time":0.051,"Actual Rows":1,"Actual Loops":1,"Index Cond":"(id_turma = di.id_turma)","Rows Removed by Index Recheck":0}]},"Planning Time":0.894,"Triggers":[],"Execution Time":0.505}]
 **/

-- 10
SELECT
	*
FROM
	usuario
WHERE
	nome LIKE '%carlos%'
	AND tipo <> 'administrador';

/** EXPLAIN ANALYZE antes dos indices
 * [{"Plan":{"Node Type":"Seq Scan","Parallel Aware":false,"Async Capable":false,"Relation Name":"usuario","Alias":"usuario","Startup Cost":0,"Total Cost":18.25,"Plan Rows":1,"Plan Width":120,"Actual Startup Time":0.043,"Actual Total Time":0.044,"Actual Rows":0,"Actual Loops":1,"Filter":"((nome ~~ '%carlos%'::text) AND (tipo <> 'administrador'::tipo_usuario))","Rows Removed by Filter":9},"Planning Time":0.112,"Triggers":[],"Execution Time":0.079}]
 * EXPLAIN ANALYZE depois dos indices
 * [{"Plan":{"Node Type":"Seq Scan","Parallel Aware":false,"Async Capable":false,"Relation Name":"usuario","Alias":"usuario","Startup Cost":0,"Total Cost":1.14,"Plan Rows":1,"Plan Width":120,"Actual Startup Time":0.043,"Actual Total Time":0.044,"Actual Rows":0,"Actual Loops":1,"Filter":"((nome ~~ '%carlos%'::text) AND (tipo <> 'administrador'::tipo_usuario))","Rows Removed by Filter":9},"Planning Time":0.174,"Triggers":[],"Execution Time":0.072}]
 **/